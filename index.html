<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>理科実験シミュレーター</title>
    <style>
        :root {
            --border-color: #ccc;
            --background-color: #f4f4f9;
            --workspace-bg: #fff;
            --selected-outline-color: #007bff;
        }
        body {
            font-family: sans-serif;
            display: flex;
            flex-direction: column;
            height: 100vh;
            margin: 0;
            background-color: var(--background-color);
        }
        .title-bar {
            padding: 10px;
            text-align: center;
            border-bottom: 1px solid var(--border-color);
            background: #e9ecef;
        }
        .title-bar h1 {
            margin: 0;
            font-size: 1.5em;
        }
        #app-container {
            display: flex;
            flex-grow: 1;
            height: 0;
        }
        #palette {
            width: 250px;
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
        }
        .tabs {
            display: flex;
        }
        .tab {
            flex: 1;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            border-bottom: 1px solid var(--border-color);
            background-color: #eee;
        }
        .tab.active {
            background-color: var(--workspace-bg);
            border-bottom-color: transparent;
        }
        .item-list {
            flex-grow: 1;
            overflow-y: auto;
            padding: 10px;
        }
        .item {
            display: flex;
            align-items: center;
            padding: 5px;
            cursor: grab;
            margin-bottom: 10px;
            border: 1px solid transparent;
            border-radius: 4px;
        }
        .item.clickable {
            cursor: pointer;
        }
        
        .item:hover {
            background-color: #e9e9e9;
        }
        .item img, .item svg {
            width: 40px;
            height: 40px;
            margin-right: 10px;
        }
        .item span {
            font-size: 14px;
        }
        #main-area {
            flex-grow: 1;
            display: flex;
        }
        #workspace {
            flex-grow: 1;
            position: relative;
            overflow: hidden;
            background-color: var(--workspace-bg);
        }
        .workspace-item {
            position: absolute;
            cursor: move;
        }
        .workspace-item.selected {
            outline: 2px solid var(--selected-outline-color);
            outline-offset: 2px;
        }
        .workspace-item svg {
            width: 100%;
            height: 100%;
            pointer-events: none;
        }
        #controls-log {
            width: 300px;
            border-left: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            padding: 10px;
        }
        #controls h3, #log h3 {
            margin-top: 0;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 5px;
        }
        .control-group {
            margin-bottom: 15px;
        }
        .control-group label {
            display: block;
            margin-bottom: 5px;
            font-size: 14px;
        }
        .control-group input {
            width: 100%;
        }
        #log {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }
        #log-entries {
            flex-grow: 1;
            overflow-y: auto;
            font-size: 12px;
            background-color: #fdfdfd;
            border: 1px solid #eee;
            padding: 5px;
        }
        #log-entries p {
            margin: 0 0 5px;
        }
        .hidden {
            display: none;
        }
        button {
            width: 100%;
            padding: 10px;
            margin-top: 10px;
            cursor: pointer;
        }
        #delete-btn {
            background-color: #dc3545;
            color: white;
            border: none;
        }
        #reset-btn {
            background-color: #6c757d;
            color: white;
            border: none;
        }

        /* Modal Styles */
        #modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        #amount-modal {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            width: 300px;
        }
        #amount-modal h3 {
            margin-top: 0;
        }
        #amount-modal .input-group {
            display: flex;
            margin-bottom: 15px;
        }
        #amount-modal input[type="number"] {
            flex-grow: 1;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px 0 0 4px;
        }
        #amount-modal select {
            padding: 8px;
            border: 1px solid #ccc;
            border-left: none;
            border-radius: 0 4px 4px 0;
        }
        #amount-modal .buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        #amount-modal button {
            width: auto;
            padding: 8px 20px;
            border-radius: 4px;
            border: 1px solid #ccc;
        }
        #modal-ok {
            background-color: #007bff;
            color: white;
            border-color: #007bff;
        }
    </style>
</head>
<body>
    <!-- Global SVG definitions -->
    <svg width="0" height="0" style="position:absolute;z-index:-1;">
      <defs>
        <pattern id="powder" patternUnits="userSpaceOnUse" width="5" height="5">
          <circle cx="2.5" cy="2.5" r="1" fill="#a9a9a9"></circle>
        </pattern>
      </defs>
    </svg>

    <div class="title-bar">
        <h1>理科実験シミュレーター</h1>
    </div>

    <div id="app-container">
        <div id="palette">
            <div class="tabs">
                <div class="tab active" data-tab="kigu">器具</div>
                <div class="tab" data-tab="kotai">固体</div>
                <div class="tab" data-tab="ekitai">液体</div>
            </div>
            <div id="kigu-list" class="item-list"></div>
            <div id="kotai-list" class="item-list hidden"></div>
            <div id="ekitai-list" class="item-list hidden"></div>
        </div>

        <div id="main-area">
            <div id="workspace"></div>
            <div id="controls-log">
                <div id="controls">
                    <h3>操作</h3>
                    <div id="selection-controls" class="hidden">
                        <div class="control-group">
                            <label for="size-input">サイズ (<span id="size-value">100</span>%)</label>
                            <input type="range" id="size-input" min="20" max="300" value="100">
                        </div>
                        <div class="control-group">
                            <label for="angle-input">角度 (<span id="angle-value">0</span>°)</label>
                            <input type="range" id="angle-input" min="0" max="360" value="0">
                        </div>
                        <button id="delete-btn">選択中のアイテムを削除</button>
                    </div>
                    <p id="no-selection">アイテムを選択してください</p>
                    <button id="reset-btn">すべてリセット</button>
                </div>
                <div id="log">
                    <h3>ログ</h3>
                    <div id="log-entries"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Amount Input Modal -->
    <div id="modal-backdrop" style="display: none;">
        <div id="amount-modal">
            <h3 id="modal-title"></h3>
            <div class="input-group">
                <input type="number" id="modal-amount" value="10" min="0">
                <select id="modal-unit"></select>
            </div>
            <div class="buttons">
                <button id="modal-cancel">キャンセル</button>
                <button id="modal-ok">OK</button>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', async () => {
        const svgCache = {};
        const kiguNameMap = {
            'alcohol-lamp': 'アルコールランプ', 'beaker': 'ビーカー', 'conical_beaker': '三角フラスコ',
            'conical_beaker_tall': 'コニカルビーカー', 'evaporating_dish': '蒸発皿', 'flask': 'メスフラスコ',
            'funnel': 'ろうと', 'gas_jar': '集気びん', 'glass_lid': 'ガラスふた',
            'graduated_cylinder': 'メスシリンダー', 'stand': 'スタンド', 'test_tube': '試験管',
            'tripod': '三脚', 'whole_pipette': 'ホールピペット', 'wire_gauze': '金網'
        };
        const containerNames = ['beaker', 'conical_beaker', 'conical_beaker_tall', 'flask', 'test_tube', 'graduated_cylinder', 'evaporating_dish'];
        const items = {
            kigu: Object.keys(kiguNameMap),
            kotai: ['NaOH', 'NaCl', 'NaHCO3', 'CaCO3'],
            ekitai: ['H₂O', 'HCl', 'H₂SO₄', 'HNO₃', 'CH₃COOH']
        };

        // --- UI & Item Generation ---
        const kiguList = document.getElementById('kigu-list');
        const kotaiList = document.getElementById('kotai-list');
        const ekitaiList = document.getElementById('ekitai-list');
        const workspace = document.getElementById('workspace');
        const logEntries = document.getElementById('log-entries');
        const tabs = document.querySelectorAll('.tab');
        let selectedItem = null;
        let itemIdCounter = 0;

        // --- Modal Elements & Logic ---
        const modalBackdrop = document.getElementById('modal-backdrop');
        const modalTitle = document.getElementById('modal-title');
        const modalAmount = document.getElementById('modal-amount');
        const modalUnit = document.getElementById('modal-unit');
        const modalOk = document.getElementById('modal-ok');
        const modalCancel = document.getElementById('modal-cancel');
        let modalResolve = null;

        function showAmountModal(chemicalData) {
            modalTitle.textContent = `「${chemicalData.displayName}」を追加`;
            modalUnit.innerHTML = ''; // Clear previous options
            const units = chemicalData.type === 'ekitai' 
                ? { 'L': 'L', 'dL': 'dL', 'mL': 'mL' }
                : { 'kg': 'kg', 'g': 'g', 'mg': 'mg' };
            
            for (const [value, text] of Object.entries(units)) {
                const option = document.createElement('option');
                option.value = value;
                option.textContent = text;
                modalUnit.appendChild(option);
            }
            modalUnit.value = chemicalData.type === 'ekitai' ? 'mL' : 'g';

            modalBackdrop.style.display = 'flex';
            modalAmount.focus();
            modalAmount.select();

            return new Promise(resolve => { modalResolve = resolve; });
        }

        modalOk.addEventListener('click', () => {
            const amount = parseFloat(modalAmount.value);
            if (isNaN(amount) || amount <= 0) {
                alert('有効な数値を入力してください。');
                return;
            }
            modalBackdrop.style.display = 'none';
            if (modalResolve) modalResolve({ amount, unit: modalUnit.value });
        });

        modalCancel.addEventListener('click', () => {
            modalBackdrop.style.display = 'none';
            if (modalResolve) modalResolve(null);
        });

        // --- Asset Loading ---
        async function loadSvg(url) {
            if (svgCache[url]) return svgCache[url];
            const response = await fetch(url);
            const text = await response.text();
            svgCache[url] = text;
            return text;
        }

        // --- Substance & Visuals Logic ---
        async function onChemicalClick(e) {
            const clickedItemData = e.currentTarget.dataset;
            if (!selectedItem) {
                alert('先に対象の容器を選択してください。');
                return;
            }
            const targetData = selectedItem.dataset;
            if (targetData.type !== 'kigu' || !containerNames.includes(targetData.name)) {
                alert('液体や固体は容器にのみ追加できます。');
                return;
            }

            const result = await showAmountModal(clickedItemData);
            if (!result) return; // User cancelled

            const { amount, unit } = result;
            logAction(`「${targetData.displayName}」に「${clickedItemData.displayName}」を ${amount}${unit} 追加しました。`);
            
            // Original logic to show content (fixed amount)
            const contentPath = selectedItem.querySelector('#content');
            if (!contentPath) {
                console.error('This container is not properly configured to hold content.');
                return;
            }

            const contentType = clickedItemData.type;
            contentPath.style.fill = contentType === 'ekitai' ? 'rgba(173, 216, 230, 0.7)' : 'url(#powder)';
            contentPath.style.display = 'block';
        }

        function createPaletteItem(list, data) {
            const item = document.createElement('div');
            item.className = 'item';
            item.dataset.type = data.type;
            item.dataset.name = data.name;
            item.dataset.displayName = data.displayName;

            if (data.type === 'kigu' && containerNames.includes(data.name)) {
                item.classList.add('container-item');
            }

            const img = document.createElement('img');
            img.src = data.icon;
            item.appendChild(img);

            const span = document.createElement('span');
            span.textContent = data.displayName;
            item.appendChild(span);

            if (data.type === 'kigu') {
                item.draggable = true;
                item.addEventListener('dragstart', handleDragStart);
            } else {
                item.classList.add('clickable');
                item.addEventListener('click', onChemicalClick);
            }
            list.appendChild(item);
        }

        // Sort the equipment list for display
        const allKigu = Object.keys(kiguNameMap);
        const containers = allKigu.filter(name => containerNames.includes(name));
        const heatingItems = ['alcohol-lamp', 'stand', 'tripod', 'wire_gauze'];
        const others = allKigu.filter(name => !containerNames.includes(name) && !heatingItems.includes(name));
        const sortedKigu = [...containers, ...heatingItems, ...others];

        sortedKigu.forEach(name => createPaletteItem(kiguList, { type: 'kigu', name, displayName: kiguNameMap[name], icon: `images/${name}.svg` }));
        items.kotai.forEach(name => createPaletteItem(kotaiList, { type: 'kotai', name, displayName: name, icon: 'images/beaker.svg' }));
        items.ekitai.forEach(name => createPaletteItem(ekitaiList, { type: 'ekitai', name, displayName: name, icon: 'images/beaker.svg' }));

        // --- Main Application Logic ---
        async function createWorkspaceItem(data, x, y) {
            const id = `item-${itemIdCounter++}`;
            const div = document.createElement('div');
            div.className = 'workspace-item';
            div.id = id;
            div.dataset.name = data.name;
            div.dataset.displayName = data.displayName;
            div.dataset.type = data.type;
            div.style.left = `${x}px`;
            div.style.top = `${y}px`;
            div.style.width = '100px';
            div.style.height = '100px';

            if (data.type === 'kigu') {
                const svgText = await loadSvg(`images/${data.name}.svg`);
                div.innerHTML = svgText;
            }
            
            workspace.appendChild(div);
            makeDraggable(div);
            div.addEventListener('click', (e) => {
                e.stopPropagation();
                select(div);
            });
            logAction(`「${data.displayName}」を作業エリアに配置しました。`);
            select(div);
        }

        function select(item) {
            if (selectedItem) {
                selectedItem.classList.remove('selected');
            }
            if (selectedItem === item) {
                selectedItem = null;
            } else {
                selectedItem = item;
            }
            
            if (selectedItem) {
                selectedItem.classList.add('selected');
                workspace.appendChild(selectedItem); // Bring to front
            }
            updateControls(selectedItem);
        }

        // --- Event Handlers ---
        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                tabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                document.querySelectorAll('.item-list').forEach(list => list.classList.add('hidden'));
                document.getElementById(`${tab.dataset.tab}-list`).classList.remove('hidden');
            });
        });

        function handleDragStart(e) {
            e.dataTransfer.setData('text/plain', JSON.stringify(e.currentTarget.dataset));
        }

        workspace.addEventListener('dragover', (e) => e.preventDefault());
        workspace.addEventListener('drop', (e) => {
            e.preventDefault();
            const data = JSON.parse(e.dataTransfer.getData('text/plain'));
            const workspaceRect = workspace.getBoundingClientRect();
            const x = e.clientX - workspaceRect.left - 50;
            const y = e.clientY - workspaceRect.top - 50;
            if (data.type === 'kigu') {
                createWorkspaceItem(data, x, y);
            }
        });
        workspace.addEventListener('click', () => select(null));

        // --- Draggable Logic ---
        function makeDraggable(element) {
            let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
            element.onmousedown = dragMouseDown;

            function dragMouseDown(e) {
                if (e.target.closest('a, button, input')) return;
                e.preventDefault();
                pos3 = e.clientX;
                pos4 = e.clientY;
                document.onmouseup = closeDragElement;
                document.onmousemove = elementDrag;
            }

            function elementDrag(e) {
                e.preventDefault();
                pos1 = pos3 - e.clientX;
                pos2 = pos4 - e.clientY;
                pos3 = e.clientX;
                pos4 = e.clientY;
                element.style.top = (element.offsetTop - pos2) + "px";
                element.style.left = (element.offsetLeft - pos1) + "px";
            }

            function closeDragElement() {
                document.onmouseup = null;
                document.onmousemove = null;
            }
        }

        // --- Controls & Logging ---
        const sizeInput = document.getElementById('size-input');
        const angleInput = document.getElementById('angle-input');
        const sizeValue = document.getElementById('size-value');
        const angleValue = document.getElementById('angle-value');
        const deleteBtn = document.getElementById('delete-btn');
        const resetBtn = document.getElementById('reset-btn');
        const selectionControls = document.getElementById('selection-controls');
        const noSelection = document.getElementById('no-selection');

        function updateControls(item) {
            if (item) {
                selectionControls.classList.remove('hidden');
                noSelection.classList.add('hidden');
                const transform = new DOMMatrix(getComputedStyle(item).transform);
                const angle = Math.round(Math.atan2(transform.b, transform.a) * (180 / Math.PI));
                const scale = Math.round(transform.a / Math.cos(angle * Math.PI / 180) * 100);
                sizeInput.value = scale;
                sizeValue.textContent = scale;
                angleInput.value = angle < 0 ? angle + 360 : angle;
                angleValue.textContent = angle < 0 ? angle + 360 : angle;
            } else {
                selectionControls.classList.add('hidden');
                noSelection.classList.remove('hidden');
            }
        }

        function applyTransform() {
            if (!selectedItem) return;
            const size = sizeInput.value / 100;
            const angle = angleInput.value;
            selectedItem.style.transform = `rotate(${angle}deg) scale(${size})`;
        }

        sizeInput.addEventListener('input', () => { sizeValue.textContent = sizeInput.value; applyTransform(); });
        angleInput.addEventListener('input', () => { angleValue.textContent = angleInput.value; applyTransform(); });
        deleteBtn.addEventListener('click', () => {
            if (selectedItem) {
                logAction(`「${selectedItem.dataset.displayName}」を削除しました。`);
                selectedItem.remove();
                select(null);
            }
        });
        resetBtn.addEventListener('click', () => {
            if (confirm('本当にすべてリセットしますか？')) {
                workspace.innerHTML = '';
                logEntries.innerHTML = '';
                select(null);
                logAction('作業エリアをリセットしました。');
            }
        });

        function logAction(message) {
            const p = document.createElement('p');
            p.textContent = message;
            logEntries.appendChild(p);
            logEntries.scrollTop = logEntries.scrollHeight;
        }
        
        logAction('シミュレーションを開始しました。');
    });
    </script>
</body>
</html>